<!-- 
水平方向のスプリッタで区切られたウィンドウ
Usage:
    <horizontal_splitter_window>
        <yield to="left_pane"></yield>
        <yield to="splitter"></yield>
        <yield to="right_pane"></yield>
    </horizontal_splitter_window>


ハンドラ：
    ("splitter_pos_updated", splitterPos):
        スプリッタ位置が変化した場合に，登録したハンドラが呼ばれる
    ("update_pane_size", splitterPos):
        スプリッタ位置を外部から変更したいときに呼ぶ
-->

<horizontal_splitter_window class="horizontal_splitter_window">
    
    <div class="horizontal_splitter_window_container" ref="container">
        <div ref="left_pane" style="width:30%;">
            <yield from="left_pane"/>
        </div>
        <div ref="splitter">
            <yield from="splitter"/>
        </div>
        <div ref="right_pane">
            <yield from="right_pane"/>
        </div>
    </div>

    <style>
        /* カスタムタグは デフォルトで inline なので block を指定してやる．
        そうしないと，width が効かない */
        horizontal_splitter_window.horizontal_splitter_window {
            width: 100%;
            height: 100%;
            display: block;
        }
        .horizontal_splitter_window_container {
            width: 100%;
            height: 100%;
            display: flex;          /* CSS3 flexbox による配置を有効に */
            flex-direction: row;    /* 子要素を横方向に並べる*/  
            flex: auto;
        }
        div {
            position: relative;     /* ここを relative にしておかないと，子要素が外にあふれ出す */
            height: 100%;
        }
    </style>
    
    <script>
        let self = this;
        self.lastPos = 0;
        self.inDrag = false;
        self.id = self.opts.id; // タブ ID は上位から ID 属性として与える
        self.valid = false;

        self.on("mount", function(){
            // ドラッグ始はスプリッタ
            let splitter = self.refs.splitter;
            splitter.onmousedown = self.onMouseDown;

            // splitter 以外からも捉えられるように window に
            window.addEventListener("mousemove", self.onMouseMove);
            window.addEventListener("mouseup", self.onMouseUp);

            // ウィンドウサイズの変更
            // window 以外の要素は resizeObserver を使う必要がある
            self.resizeObserver.observe(self.refs.container);

            self.valid = true;
        });

        self.on("unmount", function(){
            self.valid = false;
            window.removeEventListener("mousemove", self.onMouseMove);
            window.removeEventListener("mouseup", self.onMouseUp);
            self.resizeObserver.disconnect();   // 全要素解放
        });


        self.onMouseDown = function(e){
            self.lastPos = e.clientX;
            self.inDrag = true;

            // クリック時に他所にフォーカスが奪われるのを防ぐ
            e.preventDefault();
            //console.log(`mousedown ${self.id}`);
        };

        self.onMouseUp = function(){
            self.inDrag = false;
            //console.log(`mouseup ${self.id}`);
        };

        self.onMouseMove = function(e){
            if (!self.inDrag) {
                return;
            }

            let container = self.refs.container;

            // ウィンドウ外にカーソルがでたときのため補正
            let containerWidth = container.offsetWidth;
            let pos = Math.min(Math.max(e.clientX, 0), containerWidth);
            
            // 差分を求める
            let diff = pos - self.lastPos;
            self.lastPos = pos;

            // 差分を現在の幅に足す
            let left_pane = self.refs.left_pane;
            let splitterPos = left_pane.offsetWidth + diff;
            //dispatcher.trigger(ACTION.PANE_SPLITTER_MOVE, splitterPos);

            self.UpdatePaneSize(splitterPos);
            self.trigger("splitter_pos_updated", splitterPos);
            
            //console.log(`move ${pos} ${diff} ${left_pane.offsetWidth} ${splitterPos}`);
            //console.log(`mousemove ${self.id}`);
        };

        self.resizeObserver = new ResizeObserver(   // eslint-disable-line
            () => {
                let left_pane = self.refs.left_pane;
                let splitterPos = left_pane.offsetWidth;
                self.UpdatePaneSize(splitterPos);
                self.trigger("splitter_pos_updated", splitterPos);
            }
        );

        self.UpdatePaneSize = function(splitterPos){

            let container = self.refs.container;
            let left = self.refs.left_pane;
            let splitter = self.refs.splitter;
            let right = self.refs.right_pane;

            // 幅
            left.style.width = `${splitterPos}px`;
            right.style.width = 
                `${container.offsetWidth - splitterPos - splitter.offsetWidth}px`;
            //console.log(`update ${store.window.width} ${store.activeTab.splitterPos} ${right.offsetWidth}`);
            self.update();
        };

        self.on("update_pane_size", (splitterPos) => {
            self.UpdatePaneSize(splitterPos);
        });

    </script>
</horizontal_splitter_window>

